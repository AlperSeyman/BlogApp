<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    {% if title %}
      <title>Blog - {{ title }}</title>
    {% else %}
      <title>Blog</title>
    {% endif %}
    <meta name="description" content="FastAPI Tutorial">
    <meta name="author" content="Corey Schafer">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous">

    <link rel="stylesheet" type="text/css" href="{{ url_for('static', path='css/main.css') }}">

    <meta name="theme-color" content="#527c9f">

    <link rel="icon" href="{{ url_for('static', path='icons/favicon.ico') }}" sizes="any">
    <link rel="icon" href="{{ url_for('static', path='icons/icon.svg') }}" type="image/svg+xml">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', path='icons/icon.png') }}">
    <link rel="manifest" href="{{ url_for('static', path='site.webmanifest') }}">

    <script>
      (function() {
        // 1. Check local storage
        const savedTheme = localStorage.getItem('theme') || 'auto';

        // 2. Check system preference
        const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';

        // 3. Decide which to apply
        const themeToApply = savedTheme === 'auto' ? systemTheme : savedTheme;

        // 4. Apply it immediately to the HTML tag
        document.documentElement.setAttribute('data-bs-theme', themeToApply);
      })();
    </script>
    </head>
  <body class="d-flex flex-column min-vh-100">
    <header class="site-header">
      <nav class="navbar navbar-expand-md bg-steel fixed-top"
           data-bs-theme="dark">
        <div class="container">
          <a class="navbar-brand me-4" href="{{ url_for('home') }}">Blog</a>
          <button class="navbar-toggler"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#navbarToggle"
                  aria-controls="navbarToggle"
                  aria-expanded="false"
                  aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarToggle">
            <div class="navbar-nav me-auto">
              <a class="nav-link active" aria-current="page" href="{{ url_for('home') }}">Home</a>
            </div>
            <div class="navbar-nav">
              <!--Once auth is set up, this button will only be visible when user logged in -->
              <button class="btn btn-outline-light mb-2 mb-md-0 me-md-2"
                      type="button"
                      data-bs-toggle="modal"
                      data-bs-target="#createPostModal">New Post</button>
              <a class="btn btn-outline-light mb-2 mb-md-0 me-md-2" href="#">Login</a>
              <a class="btn btn-light mb-2 mb-md-0 me-md-3" href="#">Register</a>
              <div class="nav-item dropdown">
                <a class="nav-link dropdown-toggle"
                   href="#"
                   role="button"
                   id="bd-theme"
                   data-bs-toggle="dropdown"
                   aria-expanded="false">
                  <span id="bd-theme-text">üåó Auto</span>
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme">
                  <li>
                    <button class="dropdown-item" type="button" data-bs-theme-value="light">üåù Light</button>
                  </li>
                  <li>
                    <button class="dropdown-item" type="button" data-bs-theme-value="dark">üåö Dark</button>
                  </li>
                  <li>
                    <button class="dropdown-item" type="button" data-bs-theme-value="auto">üåó Auto</button>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main role="main" class="container">
      <div class="row">
        <div class="col-md-8">
          {% block content %}
          {% endblock content %}
        </div>
        <aside class="col-md-4">
          <div class="content-section py-3 px-4 mb-4">
            <h3>Our Sidebar</h3>
            <p class="text-body-secondary">You can put any information here you'd like.</p>
            <ul class="list-group">
              <li class="list-group-item">Latest Posts</li>
              <li class="list-group-item">Announcements</li>
              <li class="list-group-item">Calendars</li>
              <li class="list-group-item">etc</li>
            </ul>
          </div>
        </aside>
      </div>
    </main>

    <footer class="mt-auto py-3 bg-body-tertiary border-top">
      <div class="container text-center">
        <p class="text-body-secondary mb-0">
          ¬© <span id="year"></span> A.S
        </p>
      </div>
    </footer>

    <!-- Create Post Modal -->
    <div class="modal fade"
         id="createPostModal"
         tabindex="-1"
         aria-labelledby="createPostModalLabel"
         aria-hidden="true">
         <div class="modal-dialog">
              <div class="modal-content">
                   <div class="modal-header">
                        <h5 class="modal-title" id="createPostModalLabel">New Post</h5>
                        <button type="button"
                                class="btn-close"
                                data-bs-dismiss="modal"
                                aria-label="Close"></button>
                    </div>
                    <form id="createPostForm">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="title" class="form-label">Title</label>
                                <input type="text" class="form-control" id="title" name="title" required>
                            </div>
                            <div class="mb-3">
                                <label for="content" class="form-label">Content</label>
                                <textarea class="form-control" id="content" name="content" rows="5" required></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button"
                                    class="btn btn-outline-secondary"
                                    data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Post</button>
                        </div>
                    </form>
                </div>
            </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade"
             id="successModal"
             tabindex="-1"
             aria-labelledby="successModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title" id="successModalLabel">Success</h5>
                        <button type="button"
                                class="btn-close btn-close-white"
                                data-bs-dismiss="modal"
                                aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p id="successMessage" class="fs-5"></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
    </div>

    <!-- Error Modal -->
    <div class="modal fade"
             id="errorModal"
             tabindex="-1"
             aria-labelledby="errorModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="errorModalLabel">Error</h5>
                        <button type="button"
                                class="btn-close btn-close-white"
                                data-bs-dismiss="modal"
                                aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p id="errorMessage" class="fs-5"></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
    </div>


    <script>document.getElementById('year').textContent = new Date().getFullYear();</script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>

    <script>
      const setTheme = (theme) => {
        if (theme === 'auto') {
          document.documentElement.setAttribute('data-bs-theme',
            window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        } else {
          document.documentElement.setAttribute('data-bs-theme', theme);
        }
        localStorage.setItem('theme', theme);

        // Update button text
        const themeText = { light: 'üåù Light', dark: 'üåö Dark', auto: 'üåó Auto' };
        document.getElementById('bd-theme-text').textContent = themeText[theme];
      };

      // Set theme on click
      document.querySelectorAll('[data-bs-theme-value]').forEach(button => {
        button.addEventListener('click', () => setTheme(button.getAttribute('data-bs-theme-value')));
      });

      // Initialize (Keep this to ensure button text is correct)
      setTheme(localStorage.getItem('theme') || 'auto');
    </script>

    <!-- Create Post Form Handler -->
    <script type="module">
        import {
        getErrorMessage,
        hideModal,
        showModal,
        } from "/static/js/utils.js";

        const createForm = document.getElementById("createPostForm");

        createForm.addEventListener("submit", async (event) => {
        // Stop default form submission - we'll handle it with JavaScript
        event.preventDefault();

        // Gather form values into a plain object {title: "...", content: "..."}
        const formData = new FormData(createForm);
        const postData = Object.fromEntries(formData.entries());

        // TEMPORARY - hardcoded until authorization (Tutorial 11)
        postData.user_id = 1;

        try {
            // POST to our API as JSON
            const response = await fetch("/api/posts", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(postData),
            });

            if (response.ok) {
            const data = await response.json();
            document.getElementById("successMessage").textContent =
                `Post "${data.title}" created successfully!`;

            hideModal("createPostModal");
            showModal("successModal");

            // Clear form
            createForm.reset();

            // Reload page after modal is hidden to show new post
            document
                .getElementById("successModal")
                .addEventListener(
                "hidden.bs.modal",
                () => {
                    window.location.reload();
                },
                { once: true },
                );
            } else {
            const error = await response.json();
            document.getElementById("errorMessage").textContent =
                getErrorMessage(error);

            hideModal("createPostModal");
            showModal("errorModal");
            }
        } catch (error) {
            document.getElementById("errorMessage").textContent =
            "Network error. Please check your connection and try again.";
            showModal("errorModal");
        }
        });
    </script>

    {% block scripts %}
    {% endblock scripts %}



  </body>
</html>